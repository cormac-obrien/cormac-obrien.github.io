<!doctype html>
<html>
  <head>
    <title>GSoC 2015: QEMU OS 9 Support</title>
    <link rel="stylesheet"
          type="text/css"
          href="../style.css" />
  </head>

  <body>
    <h2 style='float:left'>GSoC 2015</h2>
    <h2 style='float:right'>Adding Support for Mac OS 9 to QEMU</h2>

    <div id='head-sep'></div>

    <h3>Overview</h3>
    <p>As of version 2.2.1, QEMU does not support emulation of a machine
       running Mac OS 9. This GSoC project aims to implement support for OS
       9.</p>

    <h3>Testing</h3>
    <p>See the <a href='http://c-obrien.org/qemu-os9/testing/'>testing
       page</a> for information on viewing our progress.</p>

    <h3>Log</h3>
    <h4>2015.08.18</h4>
    <p>It appears that OS 9 is attempting to write to the OHCI HcDoneHead
       register, which QEMU doesn't support. This doesn't seem like a common
       operation, and most documentation marks the register read-only.</p>
    <p>We've also determined that it's possible to skip into Macsbug by
       holding the control key when the splash screen appears.</p>

    <h4>2015.08.17</h4>
    <p>The (hopefully) final changes to OpenBIOS have been sent out to the
       mailing list for review. They are:</p>
    <ul>
      <li>
        <a href='http://www.openfirmware.info/pipermail/openbios/2015-August/008764.html'>
           ppc: fix up power-mgt properties</a></li>
      <li>
        <a href='http://www.openfirmware.info/pipermail/openbios/2015-August/008765.html'>
           ppc: add ESCC legacy support</a></li>
      <li>
        <a href='http://www.openfirmware.info/pipermail/openbios/2015-August/008766.html'>
           ppc: fix CUDA ADB packet header format</a></li>
      <li>
        <a href='http://www.openfirmware.info/pipermail/openbios/2015-August/008766.html'>
           ppc: fix up IDE device tree and control transfer</a></li>
    </ul>

    <h4>2015.07.01</h4>
    <p>Alex has made significant progress on CUDA and ADB emulation. However,
       a fix to the ADB bus has broken OpenBIOS's keyboard detection.</p>

    <h4>2015.06.20</h4>
    <p>Six OpenBIOS patches have been committed to trunk &mdash; see OpenBIOS
       revisions 1341 through 1346.</p>

    <h4>2015.06.18</h4>
    <p>A number of outstanding OpenBIOS patches have been reworked and
       reviewed.  They are now waiting to be committed to OpenBIOS trunk.</p>

    <h4>2015.05.10</h4>
    <p>The Adler-32 patch has been reviewed by both Mark Cave-Ayland and
       Andreas Färber.<p>

    <h4>2015.04.27</h4>
    <p>The project has been accepted into Google Summer of Code 2015!</p>

    <h4>2015.04.15</h4>
    <p>The OS gives several "fatal error" messages regarding a missing copyright
       string, missing CPU properties and an incorrect interrupts property.</p>

    <h4>2015.04.12</h4>
    <p>Mac OS 9 expects a node at '/rom' and fails if it is not present. However,
       the node can be faked, as the OS doesn't actually check any properties of
       the node.</p>

    <h4>2015.04.08</h4>
    <p>The out-of-memory error and Adler-32 patches have been submitted to the
       OpenBIOS mailing list for review.</p>

    <h4>2015.04.03</h4>
    <p>I've added the Adler-32 checksum (adapted from Adler's original zlib
       implementation), and the boot script accepts it. Thanks to Mark
       Cave-Ayland for pointing out a stack order error.</p>

    <h4>2015.04.02</h4>
    <p>The new solution is to begin parsing the boot info SGML before allocating
       memory, get the size of the boot script, and then allocate that memory.
       This solution fixes the out-of-memory error.</p>

    <h4>2015.03.29</h4>
    <p>A more thorough examination of the code calculating the size of the boot
       script shows that the file size is actually being calculated correctly,
       but OS 9 expects the host firmware to stop loading at the ASCII EOT (0x04) 
       immediately following the script. The rest of the file appears to be null
       padding and machine code.</p>

    <h4>2015.03.28</h4>
    <p>The script fails because it expects the host firmware to implement a word
       <code>adler32</code>, which I can only assume is an Adler-32 checksum.
       It's not entirely clear how OS 9 expects it to be implemented, but it
       should be fairly close to the reference implementation (zlib).</p>

    <h4>2015.03.27</h4>
    <p>I've confirmed that OpenBIOS is able to find the boot script, and by
       calculating the script size with <code>strlen()</code> instead of the
       default method it successfully loads and begins execution (this is a
       temporary workaround). Unfortunately the script still leads to a "No valid
       state" error, which most likely means that the script fails to execute
       properly.</p>

    <h4>2015.03.26</h4>
    <p>The out-of-memory error occurs in <code>bootinfo_init_program</code> while
       trying to allocate memory to load the boot script. The script is only
       about 80 lines long, so it would appear that OpenBIOS is incorrectly
       calculating the size of the boot script.</p>

    <h4>2015.03.25</h4>
    <p>OpenBIOS fails to boot from the OS 9.2.2 install ISO. This appears to be
    the result of an out-of-memory error. The launch command given is</p>
    <pre><code>$ qemu-system-ppc -m 256 -cdrom os9.iso -boot d</code></pre>

    <h3>References</h3>
    <ul>
     <li><a href="http://docs.oracle.com/cd/E19253-01/806-1379-10/">
         Writing FCode 3.x programs</a></li>
     <li><a href="http://en.wikipedia.org/wiki/Common_Hardware_Reference_Platform">
         Common Hardware Reference Platform</a> (Wikipedia)</li>
    </ul>

    <h3>Acknowledgments</h3>
    <ul>
     <li>Alexander Graf, QEMU mentor and PowerPC expert</li>
     <li>Mark Cave-Ayland, OpenBIOS mentor and maintainer</li>
     <li>John Arbuckle, project idea and contributions</li>
     <li>Andreas Färber, patch reviews</li>
    </ul>

  </body>
</html>
